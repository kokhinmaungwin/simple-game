<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Multi-Size ICO Generator</title>
<style>
  body{font-family:Arial;padding:20px;text-align:center}
  h2{margin-bottom:5px}
  p{color:#555}
  input{margin-top:15px}
  button{padding:10px 18px;border:none;border-radius:10px;font-size:16px;margin-top:20px}
</style>
</head>
<body>

<h2>PNG âžœ ICO Generator (Multi-size)</h2>
<p>Generates 16, 32, 48 and 64 pixel ICO</p>

<input type="file" id="fileInput" accept="image/*"><br>
<button id="generateBtn">Generate ICO</button>

<canvas id="canvas" width="64" height="64" style="display:none"></canvas>

<script>
function createBMPFromCanvas(canvas, size){
  const ctx = canvas.getContext("2d");
  const tmp = document.createElement("canvas");
  tmp.width = size;
  tmp.height = size;
  const tctx = tmp.getContext("2d");
  tctx.drawImage(canvas, 0, 0, size, size);

  const imgData = tctx.getImageData(0, 0, size, size);
  const pixels = imgData.data;
  const rowSize = Math.ceil((24 * size + 31) / 32) * 4;
  const imageSize = rowSize * size;
  const fileSize = 54 + imageSize;

  const buffer = new ArrayBuffer(fileSize);
  const dv = new DataView(buffer);

  dv.setUint16(0, 0x4d42, true);
  dv.setUint32(2, fileSize, true);
  dv.setUint32(10, 54, true);
  dv.setUint32(14, 40, true);
  dv.setInt32(18, size, true);
  dv.setInt32(22, -size, true);
  dv.setUint16(26, 1, true);
  dv.setUint16(28, 24, true);
  dv.setUint32(34, imageSize, true);

  let offset = 54;
  let i = 0;
  for(let y = 0; y < size; y++){
    for(let x = 0; x < size; x++){
      dv.setUint8(offset++, pixels[i+2]);
      dv.setUint8(offset++, pixels[i+1]);
      dv.setUint8(offset++, pixels[i]);
      i += 4;
    }
    while((offset - 54) % rowSize) dv.setUint8(offset++, 0);
  }
  return new Uint8Array(buffer);
}

document.getElementById("generateBtn").onclick = async () => {
  const fileInput = document.getElementById("fileInput");
  if(!fileInput.files.length){
    alert("Choose an image first ðŸ˜„");
    return;
  }

  const file = fileInput.files[0];
  const img = new Image();
  img.src = URL.createObjectURL(file);

  img.onload = () => {
    const baseCanvas = document.getElementById("canvas");
    const bctx = baseCanvas.getContext("2d");
    bctx.clearRect(0,0,64,64);
    bctx.drawImage(img,0,0,64,64);

    const sizes = [16,32,48,64];
    const bmps = sizes.map(s => createBMPFromCanvas(baseCanvas, s));

    // ICO header
    const iconCount = bmps.length;
    const headerSize = 6 + 16 * iconCount;
    let imageOffset = headerSize;

    const totalSize = headerSize + bmps.reduce((a,b)=>a+b.length,0);
    const buffer = new ArrayBuffer(totalSize);
    const dv = new DataView(buffer);

    dv.setUint16(0, 0, true);
    dv.setUint16(2, 1, true);
    dv.setUint16(4, iconCount, true);

    let offset = 6;

    bmps.forEach((bmp, i)=>{
      const size = sizes[i];
      dv.setUint8(offset++, size === 256 ? 0 : size);
      dv.setUint8(offset++, size === 256 ? 0 : size);
      dv.setUint8(offset++, 0);
      dv.setUint8(offset++, 0);
      dv.setUint16(offset, 1, true); offset+=2;
      dv.setUint16(offset, 24, true); offset+=2;
      dv.setUint32(offset, bmp.length, true); offset+=4;
      dv.setUint32(offset, imageOffset, true); offset+=4;
      new Uint8Array(buffer, imageOffset, bmp.length).set(bmp);
      imageOffset += bmp.length;
    });

    const blob = new Blob([buffer], {type:"image/x-icon"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "favicon.ico";
    a.click();
  };
};
</script>

</body>
</html>
